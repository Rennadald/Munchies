@{
    ViewData["Title"] = "Sales Report";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 fw-bold mb-2" style="color: var(--munchies-dark-green);">
                        <i class="fas fa-chart-line me-2"></i>Sales Report
                    </h1>
                    <p class="text-muted mb-0">Analyze sales performance and revenue trends</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Summary -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon primary">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                @{
                    var totalOrders = ViewBag.SalesSummary != null ? ((dynamic)ViewBag.SalesSummary).TotalOrders : 0;
                }
                <h3 class="fw-bold text-primary">@totalOrders</h3>
                <p class="text-muted mb-0">Total Orders</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon success">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                @{
                    var totalRevenue = ViewBag.SalesSummary != null ? ((dynamic)ViewBag.SalesSummary).TotalRevenue : 0m;
                }
                <h3 class="fw-bold text-success">SAR @string.Format("{0:N2}", totalRevenue)</h3>
                <p class="text-muted mb-0">Total Revenue</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon info">
                    <i class="fas fa-receipt"></i>
                </div>
                @{
                    var avgOrderValue = ViewBag.SalesSummary != null ? ((dynamic)ViewBag.SalesSummary).AverageOrderValue : 0.0;
                }
                <h3 class="fw-bold text-info">SAR @string.Format("{0:N2}", avgOrderValue)</h3>
                <p class="text-muted mb-0">Average Order Value</p>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stats-card">
                <div class="stats-icon warning">
                    <i class="fas fa-users"></i>
                </div>
                @{
                    var uniqueCustomers = ViewBag.SalesSummary != null ? ((dynamic)ViewBag.SalesSummary).UniqueCustomers : 0;
                }
                <h3 class="fw-bold text-warning">@uniqueCustomers</h3>
                <p class="text-muted mb-0">Unique Customers</p>
            </div>
        </div>
    </div>

    <!-- Revenue Trend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0" style="color: var(--munchies-dark-green);">
                        <i class="fas fa-chart-bar me-2"></i>Revenue Trend
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="50"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Packages -->
        <div class="col-lg-12 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0" style="color: var(--munchies-dark-green);">
                        <i class="fas fa-box me-2"></i>Top Packages
                    </h5>
                </div>
                <div class="card-body">
                    @if (ViewBag.TopPackages != null && ((List<dynamic>)ViewBag.TopPackages).Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Package</th>
                                        <th class="text-center">Orders</th>
                                        <th class="text-center">Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var topPackages = (List<dynamic>)ViewBag.TopPackages;
                                        for (int index = 0; index < topPackages.Count; index++)
                                        {
                                            var package = topPackages[index];
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-warning me-2">@(index + 1)</span>
                                                        <div>
                                                            <strong>@package.PackageName</strong>
                                                            <br>
                                                            <small class="text-muted">@package.MealsPerDay meals/day</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="fw-bold text-primary">@package.TotalOrders</span>
                                                </td>
                                                <td class="text-center">
                                                    @{
                                                        var packageRevenue = (decimal)package.TotalRevenue;
                                                    }
                                                    <span class="fw-bold text-success">SAR @string.Format("{0:N2}", packageRevenue)</span>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-2x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No package sales data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Revenue Chart
            const revenueChart = document.getElementById('revenueChart');

            if (revenueChart) {
                const revenueData = @Html.Raw(Json.Serialize(ViewBag.RevenueTrend ?? new List<object>()));
                const labels = revenueData.map(item => new Date(item.Date).toLocaleDateString());
                const revenue = revenueData.map(item => parseFloat(item.DailyRevenue) || 0);
                const orders = revenueData.map(item => item.OrdersCount);

                new Chart(revenueChart, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Daily Revenue (SAR)',
                                data: revenue,
                                borderColor: 'rgb(40, 167, 69)',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4
                            },
                            {
                                label: 'Number of Orders',
                                data: orders,
                                borderColor: 'rgb(23, 162, 184)',
                                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Revenue (SAR)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Number of Orders'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        }
                    }
                });
            }

            // Custom date range toggle
            const dateRangeSelect = document.getElementById('date_range');
            const customDateRange = document.getElementById('customDateRange');

            if (dateRangeSelect && customDateRange) {
                dateRangeSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDateRange.style.display = 'flex';
                    } else {
                        customDateRange.style.display = 'none';
                    }
                });
            }
        });
    </script>
}

@section Styles {
    <style>
        .stats-card {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .stats-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            }

        .stats-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

            .stats-icon.primary {
                background: rgba(0, 123, 255, 0.1);
                color: #007bff;
            }

            .stats-icon.success {
                background: rgba(40, 167, 69, 0.1);
                color: #28a745;
            }

            .stats-icon.info {
                background: rgba(23, 162, 184, 0.1);
                color: #17a2b8;
            }

            .stats-icon.warning {
                background: rgba(255, 193, 7, 0.1);
                color: #ffc107;
            }

        :root {
            --munchies-dark-green: #2e8b57;
        }
    </style>
}